<!DOCTYPE html>
<html lang="az">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RK-Pro Emerald Enterprise (Real-Time)</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #10b981; --accent: #fbbf24; --glass-bg: rgba(255, 255, 255, 0.08);
      --glass-border: rgba(255, 255, 255, 0.12); --text-color: #f8fafc;
      --sidebar-width: 260px; --danger: #ef4444;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Plus Jakarta Sans', sans-serif; }
    body { background: linear-gradient(135deg, #064e3b 0%, #020617 100%); height: 100vh; display: flex; color: var(--text-color); overflow: hidden; }

    /* Gƒ∞Rƒ∞≈û Sƒ∞STEMƒ∞ */
    #login-overlay { position: fixed; inset: 0; background: rgba(2, 6, 23, 0.98); z-index: 1000; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(15px); }
    .login-card { background: var(--glass-bg); padding: 40px; border-radius: 30px; border: 1px solid var(--glass-border); text-align: center; width: 380px; }

    /* SIDEBAR */
    .sidebar { width: var(--sidebar-width); background: var(--glass-bg); border-right: 1px solid var(--glass-border); display: flex; flex-direction: column; padding: 30px 20px; z-index: 100; flex-shrink: 0; }
    .logo-area { display: flex; align-items: center; gap: 15px; margin-bottom: 50px; }
    .logo-text { font-size: 22px; font-weight: 800; color: #fff; }
    .nav-list { list-style: none; flex-grow: 1; }
    .nav-item { padding: 14px 18px; cursor: pointer; display: flex; align-items: center; gap: 15px; font-weight: 500; font-size: 15px; color: rgba(248, 250, 252, 0.6); transition: 0.3s; border-radius: 16px; margin-bottom: 10px; }
    .nav-item.active { background: linear-gradient(135deg, var(--primary) 0%, #059669 100%); color: #fff; }

    /* MAIN AREA */
    .main-content { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; }
    .header { height: 80px; padding: 0 40px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid var(--glass-border); }
    .time-box { background: rgba(16, 185, 129, 0.1); padding: 10px 22px; border-radius: 14px; border: 1px solid rgba(16, 185, 129, 0.2); font-weight: 700; color: var(--primary); }
    .content-area { padding: 20px; flex-grow: 1; overflow: hidden; }
    .view { display: none; height: 100%; }
    .view.active { display: block; }
    .glass-window { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(15px); border: 1px solid var(--glass-border); border-radius: 24px; display: flex; flex-direction: column; padding: 20px; height: 100%; }

    /* POS ELEMENTS */
    .pos-container { display: flex; height: 100%; gap: 15px; }
    .table-item { background: rgba(255, 255, 255, 0.05); border: 1px solid var(--glass-border); border-radius: 12px; padding: 15px; text-align: center; cursor: pointer; margin-bottom: 10px; transition: 0.3s; }
    .table-item.active { border-color: var(--accent); color: var(--accent); background: rgba(251, 191, 36, 0.1); }
    .table-item.busy { border-color: var(--danger); background: rgba(239, 68, 68, 0.2); }

    .menu-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 12px; overflow-y: auto; }
    .menu-item { background: rgba(255, 255, 255, 0.05); border: 1px solid var(--glass-border); border-radius: 18px; padding: 15px; text-align: center; cursor: pointer; position: relative; }
    .menu-item b { display: block; color: var(--primary); margin-top: 5px; }
    .stock-tag { position: absolute; top: 5px; right: 8px; font-size: 10px; color: var(--accent); font-weight: bold; }
    .out-of-stock { opacity: 0.4; filter: grayscale(1); cursor: not-allowed; }

    /* ORDER SECTION (+/- v…ô Trash) */
    .order-row { display: flex; justify-content: space-between; align-items: center; background: rgba(255, 255, 255, 0.03); padding: 10px; border-radius: 14px; margin-bottom: 8px; border: 1px solid rgba(255,255,255,0.05); }
    .qty-controls { display: flex; align-items: center; gap: 8px; }
    .qty-btn { background: none; border: none; color: #fff; cursor: pointer; width: 22px; height: 22px; font-weight: bold; }
    .trash-btn { color: var(--danger); background: none; border: none; cursor: pointer; margin-left: 10px; font-size: 18px; }

    /* INPUTS & TABLES */
    .glass-input { background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); padding: 12px; border-radius: 12px; color: white; width: 100%; margin-bottom: 10px; outline: none; }
    .btn-action { padding: 15px; border: none; border-radius: 16px; color: #fff; font-weight: 700; cursor: pointer; width: 100%; transition: 0.2s; }
    .glass-table { width: 100%; border-collapse: collapse; }
    .glass-table th { text-align: left; padding: 12px; color: var(--accent); border-bottom: 2px solid var(--glass-border); }
    .glass-table td { padding: 12px; border-bottom: 1px solid var(--glass-border); vertical-align: top; }

    /* √áEK √áAPI √ú√á√úN STƒ∞L */
    @media print {
      body * { visibility: hidden; }
      #print-area, #print-area * { visibility: visible; }
      #print-area { position: absolute; left: 0; top: 0; width: 80mm; background: white; color: black; padding: 20px; font-family: 'Courier New', Courier, monospace; display: block !important; }
    }
    #print-area { display: none; }

    /* =========================
       TABLET / iPAD UYƒûUNLA≈ûDIRMA (DESKTOPA TOXUNMUR)
       ========================= */

    /* iOS scrollu yum≈üalt */
    .content-area,
    .menu-grid,
    #order-items,
    #table-list,
    #view-report .glass-window,
    #view-purchase .glass-window,
    #view-stock .glass-window,
    #view-expense .glass-window {
      -webkit-overflow-scrolling: touch;
    }

    @media (max-width: 1024px) {
      .content-area{
        overflow: auto !important;
        height: calc(100vh - 80px);
        padding-bottom: 24px;
      }
      .sidebar{
        width: 220px;
        padding: 22px 14px;
      }
      .pos-container{
        flex-direction: column;
        height: auto;
      }
      .pos-container > .glass-window{
        width: 100% !important;
      }
      #table-list{
        max-height: 220px;
        overflow: auto;
      }
      .menu-grid{
        max-height: 42vh;
        overflow: auto;
      }
      #order-items{
        max-height: 30vh;
        overflow: auto;
      }
      #view-report .glass-window{
        overflow: auto !important;
        height: auto;
        min-height: calc(100vh - 140px);
      }
      #view-report .glass-window > div[style*="overflow:auto"]{
        max-height: 55vh;
      }
      #view-purchase > div[style*="grid-template-columns"]{
        display: grid;
        grid-template-columns: 1fr !important;
      }
    }

    @media (max-width: 600px){
      .header{ padding: 0 16px; }
      .sidebar{ width: 200px; }
      .login-card{ width: min(92vw, 380px); padding: 26px; }
      .glass-window{ padding: 16px; }
    }
  </style>
</head>

<body>
  <div id="login-overlay">
    <div class="login-card">
      <i class="fa-solid fa-gem" style="font-size: 40px; color: var(--accent); margin-bottom: 20px;"></i>
      <h2 style="margin-bottom: 25px;">Sistem…ô Giri≈ü</h2>

      <!-- ADMIN EMAIL/PASS -->
      <div id="admin-pass-container" style="display:none;">
        <input type="text" id="admin-email" class="glass-input" placeholder="Admin Email (m…ôs: admin@eqzotika.local)">
        <input type="password" id="admin-password" class="glass-input" placeholder="Admin Parolu">
        <button class="btn-action" style="background:var(--primary)" onclick="tryAdminLogin()">DAXƒ∞L OL</button>
        <button onclick="cancelAdmin()" style="background:none; border:none; color:white; margin-top:10px; cursor:pointer">Geri qayƒ±t</button>
      </div>

      <!-- STAFF -->
      <div id="role-btns">
        <button class="btn-action" style="background: var(--primary); margin-bottom: 12px;" onclick="promptAdmin()">ADMIN Gƒ∞Rƒ∞≈ûƒ∞</button>
        <button class="btn-action" style="background: rgba(255,255,255,0.1);" onclick="loginUser('staff')">OFƒ∞Sƒ∞ANT Gƒ∞Rƒ∞≈ûƒ∞</button>
      </div>
    </div>
  </div>

  <aside class="sidebar">
    <div class="logo-area">
      <i class="fa-solid fa-gem" style="color:var(--accent)"></i>
      <div class="logo-text">Keeper Pro</div>
    </div>

    <ul class="nav-list">
      <li class="nav-item active" onclick="switchTab('pos', this)"><i class="fa-solid fa-cash-register"></i> Satƒ±≈ü (Kassa)</li>
      <li class="nav-item admin-only" onclick="switchTab('purchase', this)"><i class="fa-solid fa-truck-ramp-box"></i> Alƒ±≈ü (ƒ∞dxal)</li>
      <li class="nav-item admin-only" onclick="switchTab('stock', this)"><i class="fa-solid fa-boxes-stacked"></i> Stok (Anbar)</li>
      <li class="nav-item admin-only" onclick="switchTab('expense', this)"><i class="fa-solid fa-file-invoice-dollar"></i> X…ôrcl…ôr</li>
      <li class="nav-item admin-only" onclick="switchTab('report', this)"><i class="fa-solid fa-chart-line"></i> Hesabatlar</li>
    </ul>

    <button class="btn-action admin-only" style="background:rgba(255,255,255,0.1); margin-top:10px;" onclick="resetDataPrompt()">
      <i class="fa-solid fa-rotate"></i> B√úT√úN DATANI SIFIRLA
    </button>
    <button class="btn-action admin-only" style="background:rgba(255,255,255,0.1); margin-top:10px;" onclick="setResetCodePrompt()">
      <i class="fa-solid fa-key"></i> RESET KODUNU D∆èYƒ∞≈û
    </button>

    <button onclick="logoutAction()" style="background:none; border:none; color:var(--danger); cursor:pointer; margin-top:auto; padding:10px; text-align:left; font-weight:700">
      <i class="fa-solid fa-power-off"></i> Sƒ∞STEMD∆èN √áIXI≈û
    </button>
  </aside>

  <main class="main-content">
    <header class="header">
      <h2 id="page-title">Satƒ±≈ü Terminalƒ±</h2>
      <div class="time-box" id="clock">00:00:00</div>
    </header>

    <section class="content-area">
      <!-- POS -->
      <div id="view-pos" class="view active">
        <div class="pos-container">
          <div class="glass-window" style="width:180px;">
            <div style="font-weight:700; color:var(--accent); margin-bottom:15px">
              MASALAR
              <button onclick="addTablePrompt()" class="admin-only" style="float:right; background:var(--primary); color:white; border:none; border-radius:4px; padding:0 5px; cursor:pointer">+</button>
            </div>
            <div id="table-list" style="overflow-y:auto; flex:1"></div>
          </div>

          <div class="glass-window" style="flex:1;">
            <div id="menu-grid" class="menu-grid"></div>
          </div>

          <div class="glass-window" style="width:400px;">
            <div id="order-title" style="font-weight:700; color:var(--accent); margin-bottom:15px">MASA SE√áƒ∞N</div>
            <div id="order-items" style="flex:1; overflow-y:auto"></div>

            <div style="border-top: 1px solid var(--glass-border); padding-top:12px;">
              <div style="display:flex; gap:10px;">
                <select id="pay-type" class="glass-input" style="margin-bottom:0;">
                  <option value="Naƒüd">Naƒüd</option>
                  <option value="Kart">Kart</option>
                  <option value="K√∂√ß√ºrm…ô">K√∂√ß√ºrm…ô</option>
                </select>
                <input id="disc-pct" type="number" class="glass-input" style="margin-bottom:0;" placeholder="Endirim % (0)">
              </div>
              <div style="display:flex; gap:10px; margin-top:10px;">
                <input id="svc-pct" type="number" class="glass-input" style="margin-bottom:0;" placeholder="Servis % (0)">
                <button class="btn-action" style="background:rgba(255,255,255,0.1);" onclick="recalcTotals()">HESABLA</button>
              </div>
            </div>

            <div style="border-top: 1px solid var(--glass-border); padding-top:15px; margin-top:12px;">
              <div style="display:flex; justify-content:space-between; font-size:14px; font-weight:700; opacity:.9;">
                <span>ARA C∆èMƒ∞:</span><span id="sub-val">0.00</span>
              </div>
              <div style="display:flex; justify-content:space-between; font-size:14px; font-weight:700; opacity:.9; margin-top:6px;">
                <span>ENDƒ∞Rƒ∞M:</span><span id="disc-val">0.00</span>
              </div>
              <div style="display:flex; justify-content:space-between; font-size:14px; font-weight:700; opacity:.9; margin-top:6px;">
                <span>SERVƒ∞S:</span><span id="svc-val">0.00</span>
              </div>

              <div style="display:flex; justify-content:space-between; font-size:20px; font-weight:800; color:var(--accent); margin-top:10px;">
                C∆èMƒ∞: <span id="total-val">0.00</span> AZN
              </div>

              <button class="btn-action" style="background:var(--accent); color:black; margin-top:10px" onclick="printReceiptAction()"><i class="fa-solid fa-print"></i> Q∆èBZ √áAP ET</button>
              <button class="btn-action" style="background:var(--primary); margin-top:10px" onclick="completeOrderAction()">√ñD∆èNƒ∞≈ûƒ∞ TAMAMLA</button>
            </div>
          </div>
        </div>
      </div>

      <!-- PURCHASE -->
      <div id="view-purchase" class="view">
        <div style="display:grid; grid-template-columns: 350px 1fr; gap:20px; height:100%;">
          <div class="glass-window">
            <h4>Yeni Mal Alƒ±≈üƒ±</h4>
            <input type="text" id="p-name" placeholder="M…ôhsul adƒ±" class="glass-input">
            <input type="number" id="p-qty" placeholder="Miqdar" class="glass-input">
            <input type="number" id="p-cost" placeholder="Alƒ±≈ü Qiym…ôti" class="glass-input">
            <input type="number" id="p-sell" placeholder="Satƒ±≈ü Qiym…ôti" class="glass-input">
            <input type="number" id="p-min" placeholder="Minimum stok x…ôb…ôrdarlƒ±ƒüƒ± (default: 5)" class="glass-input">
            <button class="btn-action" style="background:var(--primary)" onclick="savePurchaseAction()">ANBARA VUR</button>
          </div>
          <div class="glass-window" style="overflow:auto;">
            <table class="glass-table">
              <thead>
                <tr><th>Tarix</th><th>M…ôhsul</th><th>Sayƒ±</th><th>Alƒ±≈ü</th><th>Sil</th></tr>
              </thead>
              <tbody id="pur-history"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- STOCK -->
      <div id="view-stock" class="view">
        <div class="glass-window" style="overflow:auto;">
          <h3>Anbar Qalƒ±qlarƒ±</h3>
          <table class="glass-table">
            <thead><tr><th>M…ôhsul</th><th>Stok</th><th>Qiym…ôt</th></tr></thead>
            <tbody id="stock-body"></tbody>
          </table>
        </div>
      </div>

      <!-- EXPENSE -->
      <div id="view-expense" class="view">
        <div class="glass-window" style="overflow:auto;">
          <h4>X…ôrc Qeydi (Kassa: <span id="cash-lbl">0.00</span> AZN)</h4>
          <input type="text" id="ex-n" class="glass-input" placeholder="X…ôrcin adƒ±">
          <input type="number" id="ex-v" class="glass-input" placeholder="M…ôbl…ôƒü">
          <button onclick="saveExpenseAction()" class="btn-action" style="background:var(--danger)">X∆èRCƒ∞ ∆èLAV∆è ET</button>
          <table class="glass-table" style="margin-top:20px;">
            <thead><tr><th>Tarix</th><th>X…ôrc</th><th>M…ôbl…ôƒü</th><th>Sil</th></tr></thead>
            <tbody id="ex-history"></tbody>
          </table>
        </div>
      </div>

      <!-- REPORT -->
      <div id="view-report" class="view">
        <div class="glass-window" style="overflow:hidden;">
          <h3>Maliyy…ô Hesabatƒ±</h3>

          <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:12px;">
            <input type="date" id="rep-from" class="glass-input" style="width:220px; margin-bottom:0;">
            <input type="date" id="rep-to" class="glass-input" style="width:220px; margin-bottom:0;">
            <select id="rep-table" class="glass-input" style="width:220px; margin-bottom:0;">
              <option value="">B√ºt√ºn masalar</option>
            </select>
            <button class="btn-action" style="background:rgba(255,255,255,0.1); width:220px;" onclick="renderReport()">Fƒ∞LTRL∆è</button>
          </div>

          <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:12px;">
            <input type="date" id="z-date" class="glass-input" style="width:220px; margin-bottom:0;">
            <button class="btn-action" style="background:var(--accent); color:black; width:220px;" onclick="renderZReport()">G√úNL√úK BAƒûLANI≈û (Z)</button>
            <button class="btn-action" style="background:rgba(255,255,255,0.1); width:220px;" onclick="printZReport()">Z √áAP ET</button>
          </div>

          <div id="rep-stats" style="display:flex; gap:15px; margin:20px 0; flex-wrap:wrap;"></div>

          <div id="z-box" style="display:none; margin-bottom:18px;">
            <div class="glass-window" style="height:auto; padding:15px;">
              <div style="font-weight:800; color:var(--accent); margin-bottom:10px;">Z-REPORT (G√ºnl√ºk baƒülanƒ±≈ü)</div>
              <div id="z-content" style="line-height:1.7;"></div>
            </div>
          </div>

          <!-- ‚úÖ REPORT TABLE SCROLL FIX -->
          <div style="flex:1; overflow:auto; border-top:1px solid var(--glass-border); padding-top:10px;">
            <table class="glass-table">
              <thead><tr><th>Info</th><th>Tarix</th><th>N√∂v</th><th>Detallar</th><th>M…ôbl…ôƒü</th></tr></thead>
              <tbody id="rep-history"></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>
  </main>

  <div id="print-area"></div>

  <!-- INFO MODAL -->
  <div id="info-modal" style="display:none; position:fixed; inset:0; z-index:2000; background:rgba(0,0,0,.55); backdrop-filter: blur(6px); align-items:center; justify-content:center;">
    <div class="glass-window" style="width:min(720px,92vw); height:auto; max-height:85vh; overflow:auto; padding:18px;">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px;">
        <div style="font-weight:900; color:var(--accent); font-size:16px;">
          <i class="fa-solid fa-circle-info"></i> √áek m…ôlumatƒ±
        </div>
        <button onclick="closeInfoModal()" class="btn-action" style="width:auto; padding:10px 14px; background:rgba(255,255,255,0.12);">
          Baƒüla
        </button>
      </div>
      <div id="info-content" style="line-height:1.65;"></div>
    </div>
  </div>

  <!-- REAL-TIME FIREBASE (NO NPM) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getFirestore, doc, setDoc, getDoc, deleteDoc, collection,
      onSnapshot, query, orderBy, runTransaction, getDocs, writeBatch
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
    import {
      getAuth, onAuthStateChanged, signInWithEmailAndPassword, signInAnonymously, signOut
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

    // ‚úÖ S∆èNƒ∞N CONFIG
    const firebaseConfig = {
      apiKey: "AIzaSyDb_Td0FYgrJLWlwI6dIY_g7RVoeAb9Tpk",
      authDomain: "eqzotika-2205f.firebaseapp.com",
      projectId: "eqzotika-2205f",
      storageBucket: "eqzotika-2205f.firebasestorage.app",
      messagingSenderId: "404077205202",
      appId: "1:404077205202:web:ca913cc772ae624e74ff0b"
    };

    // ==== INIT ====
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // üîß Filial
    const BRANCH_ID = "main_branch";

    // ==== PATH HELPERS ====
    const refBranch = (...parts) => doc(db, "branches", BRANCH_ID, ...parts);
    const colBranch = (...parts) => collection(db, "branches", BRANCH_ID, ...parts);
    const refTables = refBranch("meta", "tables");
    const refSettings = refBranch("meta", "settings");

    // ==== STATE ====
    const ADMIN_EMAIL_DEFAULT = "admin@eqzotika.local";
    let currentRole = "staff";
    let currentUser = null;

    let inventory = {};
    let purchases = [];
    let sales = [];
    let expenses = [];

    let tables = ["Masa 1", "Masa 2", "Masa 3"];
    let tableOrders = {};
    let activeIdx = 0;

    let unsubscribers = [];
    let clockTimer = null;

    // ==== DOM HELPERS ====
    const $ = (id) => document.getElementById(id);

    // ==== ROLE HELPERS ====
    const isAdmin = () => currentRole === "admin";
    const requireAdmin = () => {
      if (!isAdmin()) { alert("Bu b√∂lm…ô yalnƒ±z ADMIN √º√ß√ºnd√ºr!"); return false; }
      return true;
    };

    // ==== SAFE HELPERS ====
    const encName = (s) => encodeURIComponent(String(s));
    const decName = (s) => decodeURIComponent(String(s));
    const safeId = (s) => encodeURIComponent(String(s));

    function todayISO(){
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      return `${yyyy}-${mm}-${dd}`;
    }
    function toISOFromLocalDateString(dateStr){
      const try1 = new Date(dateStr);
      if(!isNaN(try1)) return try1.toISOString().slice(0,10);
      return "";
    }
    function clampPct(v){
      v = Number(v);
      if(isNaN(v) || v < 0) return 0;
      if(v > 100) return 100;
      return v;
    }
    function lowStockBadge(invItem){
      const q = Number(invItem.qty||0);
      const min = (invItem.minQty==null || invItem.minQty==="") ? 5 : Number(invItem.minQty);
      if(q <= 0) return '';
      if(q <= min) return ' ‚ö†';
      return '';
    }
    function notifyLowStock(){
      const lows = Object.entries(inventory)
        .filter(([_, d]) => {
          const q = Number(d.qty||0);
          const min = (d.minQty==null || d.minQty==="") ? 5 : Number(d.minQty);
          return q > 0 && q <= min;
        })
        .map(([n, d]) => `${n}: ${d.qty}`);
      if(lows.length){
        alert("Diqq…ôt! Minimum stok limitin…ô d√º≈ü…ôn m…ôhsullar:\n" + lows.join("\n"));
      }
    }
    function getCashNow(){
      const s = sales.reduce((a,b)=>a+(b.grandTotal ?? b.revenue ?? 0),0);
      const e = expenses.reduce((a,b)=>a+(b.val||0),0);
      return s - e;
    }

    // ==== INIT DOCS ====
    async function ensureInitDocs(){
      const tSnap = await getDoc(refTables);
      if(!tSnap.exists()){
        const initOrders = {};
        tables.forEach(t => initOrders[t] = []);
        await setDoc(refTables, { tables, tableOrders: initOrders }, { merge: true });
      }
      const sSnap = await getDoc(refSettings);
      if(!sSnap.exists()){
        await setDoc(refSettings, { resetCode: "1234" }, { merge: true });
      }
    }

    // ==== REALTIME LISTENERS ====
    function stopRealtime(){
      unsubscribers.forEach(fn => { try{ fn(); }catch(e){} });
      unsubscribers = [];
    }

    function startRealtime(){
      stopRealtime();

      unsubscribers.push(
        onSnapshot(colBranch("inventory"), (snap) => {
          const next = {};
          snap.forEach(d => {
            const v = d.data() || {};
            if(v.name) next[v.name] = v;
          });
          inventory = next;
          renderMenu();
          if(isAdmin() && $("view-stock").classList.contains("active")) renderStock();
        })
      );

      unsubscribers.push(
        onSnapshot(refTables, (snap) => {
          if(!snap.exists()) return;
          const d = snap.data() || {};
          tables = Array.isArray(d.tables) && d.tables.length ? d.tables : tables;
          tableOrders = d.tableOrders || {};
          tables.forEach(t => { if(!Array.isArray(tableOrders[t])) tableOrders[t] = []; });

          if(activeIdx < 0) activeIdx = 0;
          if(activeIdx >= tables.length) activeIdx = 0;

          renderTables();
          renderOrderList();
          recalcTotals();
          fillReportTablesDropdown();
        })
      );

      unsubscribers.push(
        onSnapshot(query(colBranch("purchases"), orderBy("id","desc")), (snap) => {
          purchases = snap.docs.map(d => d.data());
          if(isAdmin() && $("view-purchase").classList.contains("active")) renderPurchases();
        })
      );

      unsubscribers.push(
        onSnapshot(query(colBranch("sales"), orderBy("id","desc")), (snap) => {
          sales = snap.docs.map(d => d.data());
          if(isAdmin()){
            renderExpenses();
            if($("view-report").classList.contains("active")) renderReport();
          }
        })
      );

      unsubscribers.push(
        onSnapshot(query(colBranch("expenses"), orderBy("id","desc")), (snap) => {
          expenses = snap.docs.map(d => d.data());
          if(isAdmin()){
            renderExpenses();
            if($("view-report").classList.contains("active")) renderReport();
          }
        })
      );
    }

    // ==== WRITES ====
    async function writeTablesState(){
      const clean = {};
      (tables||[]).forEach(t => clean[t] = Array.isArray(tableOrders[t]) ? tableOrders[t] : []);
      await setDoc(refTables, { tables, tableOrders: clean }, { merge: true });
    }

    async function upsertInventoryItem(name, data){
      const id = safeId(name);
      await setDoc(refBranch("inventory", id), { ...data, name }, { merge: true });
    }

    async function getResetCode(){
      const snap = await getDoc(refSettings);
      return (snap.exists() && snap.data().resetCode) ? String(snap.data().resetCode) : "1234";
    }
    async function setResetCode(newCode){
      await setDoc(refSettings, { resetCode: String(newCode) }, { merge: true });
    }

    // ==== UI RENDER ====
    function renderTables(){
      const list = $("table-list");
      if(!list) return;
      if(!tables.length){
        list.innerHTML = `<div style="opacity:.7; padding:10px;">Masa yoxdur</div>`;
        return;
      }
      list.innerHTML = tables.map((t, i) => {
        const busy = (tableOrders[t] && tableOrders[t].length) ? "busy" : "";
        const active = (activeIdx===i) ? "active" : "";
        return `<div class="table-item ${active} ${busy}" onclick="selectTable(${i})">${t}</div>`;
      }).join("");
    }

    function renderMenu(){
      const grid = $("menu-grid");
      if(!grid) return;

      grid.innerHTML = Object.entries(inventory).map(([n, d]) => {
        const isOut = Number(d.qty||0) <= 0;
        const min = (d.minQty==null || d.minQty==="") ? 5 : Number(d.minQty);
        const badge = (Number(d.qty||0) <= min && Number(d.qty||0) > 0) ? "‚ö†" : "";
        return `
          <div class="menu-item ${isOut ? "out-of-stock" : ""}" onclick="addItemToOrder('${encName(n)}')">
            <span class="stock-tag">${Number(d.qty||0)}${badge}</span>
            ${n}
            <b>${Number(d.sell||0).toFixed(2)}</b>
          </div>
        `;
      }).join("");
    }

    function renderOrderList(){
      const container = $("order-items");
      container.innerHTML = "";

      if(!tables.length){
        $("order-title").innerText = "MASA YOXDUR";
        $("sub-val").innerText = "0.00";
        $("disc-val").innerText = "0.00";
        $("svc-val").innerText = "0.00";
        $("total-val").innerText = "0.00";
        return;
      }

      const tName = tables[activeIdx];
      const list = tableOrders[tName] || [];
      list.forEach(i => {
        container.innerHTML += `
          <div class="order-row">
            <span>${i.name}</span>
            <div class="qty-controls">
              <button class="qty-btn" onclick="updateOrderQty('${encName(i.name)}',-1)">-</button>
              <span>${i.qty}</span>
              <button class="qty-btn" onclick="updateOrderQty('${encName(i.name)}',1)">+</button>
            </div>
            <b>${(Number(i.price||0)*Number(i.qty||0)).toFixed(2)}</b>
            <button class="trash-btn" onclick="removeOrderItem('${encName(i.name)}')"><i class="fa-solid fa-trash"></i></button>
          </div>
        `;
      });

      $("order-title").innerText = tName.toUpperCase();
    }

    function renderPurchases(){
      const ph = $("pur-history");
      if(!ph) return;
      ph.innerHTML = (purchases||[]).map(p => `
        <tr>
          <td>${p.date || ""}</td>
          <td>${p.name || ""}</td>
          <td>${Number(p.qty||0)}</td>
          <td>${Number(p.cost||0).toFixed(2)}</td>
          <td><i class="fa-solid fa-trash" style="cursor:pointer" onclick="delPur(${p.id})"></i></td>
        </tr>
      `).join("");
    }

    function renderStock(){
      const body = $("stock-body");
      if(!body) return;
      body.innerHTML = Object.entries(inventory).map(([n, d]) => `
        <tr>
          <td>${n}</td>
          <td>${Number(d.qty||0)}${lowStockBadge(d)}</td>
          <td>${Number(d.sell||0).toFixed(2)}</td>
        </tr>
      `).join("");
    }

    function renderExpenses(){
      const cash = getCashNow();
      const cashLbl = $("cash-lbl");
      if(cashLbl) cashLbl.innerText = cash.toFixed(2);

      const tbody = $("ex-history");
      if(!tbody) return;

      tbody.innerHTML = (expenses||[]).map(e => `
        <tr>
          <td>${e.date || ""}</td>
          <td>${e.name || ""}</td>
          <td>${Number(e.val||0).toFixed(2)}</td>
          <td><i class="fa-solid fa-trash" style="cursor:pointer" onclick="deleteExpense(${e.id})"></i></td>
        </tr>
      `).join("");
    }

    function fillReportTablesDropdown(){
      const sel = $("rep-table");
      if(!sel) return;
      const curr = sel.value;
      sel.innerHTML = `<option value="">B√ºt√ºn masalar</option>` + (tables||[]).map(t => `<option value="${t}">${t}</option>`).join("");
      sel.value = curr || "";
    }

    // ==== REPORTS (INFO BUTTON + MODAL) ====
    function renderReport(){
      if(!requireAdmin()) return;

      const from = $("rep-from").value;
      const to = $("rep-to").value;
      const tableFilter = $("rep-table").value;

      const normalizeISO = (x) => x.dateISO || toISOFromLocalDateString(x.date) || "";
      const inRange = (iso) => {
        if(!iso) return true;
        if(from && iso < from) return false;
        if(to && iso > to) return false;
        return true;
      };

      const filteredSales = (sales||[])
        .map(s => ({...s, dateISO: normalizeISO(s)}))
        .filter(s => inRange(s.dateISO) && (!tableFilter || s.table === tableFilter));

      const filteredExp = (expenses||[])
        .map(e => ({...e, dateISO: normalizeISO(e)}))
        .filter(e => inRange(e.dateISO));

      const gross  = filteredSales.reduce((a,b)=>a+(b.grandTotal ?? b.revenue ?? 0),0);
      const cst    = filteredSales.reduce((a,b)=>a+(b.cost||0),0);
      const exp    = filteredExp.reduce((a,b)=>a+(b.val||0),0);
      const profit = gross - cst - exp;

      $("rep-stats").innerHTML =
        `<div class="glass-window" style="flex:1; height:auto; padding:15px;">√úmumi Satƒ±≈ü: <b>${gross.toFixed(2)}</b></div>` +
        `<div class="glass-window" style="flex:1; height:auto; padding:15px;">Xalis M…ônf…ô…ôt: <b>${profit.toFixed(2)}</b></div>` +
        `<div class="glass-window" style="flex:1; height:auto; padding:15px;">Maya: <b>${cst.toFixed(2)}</b></div>` +
        `<div class="glass-window" style="flex:1; height:auto; padding:15px;">X…ôrc: <b>${exp.toFixed(2)}</b></div>`;

      window.__repFilter = { from, to, tableFilter };

      const h = $("rep-history");
      h.innerHTML = "";

      const all = [
        ...filteredSales.map(x => ({...x, __type:"sale"})),
        ...filteredExp.map(x => ({...x, __type:"exp"}))
      ].sort((a,b)=> (b.id||0) - (a.id||0));

      all.forEach(x => {
        if(x.__type === "sale"){
          const itemsText = (x.items && x.items.length)
            ? (" | " + x.items.map(i => `${i.name} x${i.qty}`).join(", "))
            : "";

          const by = x.createdByRole === "admin"
            ? `ADMIN (${x.createdByEmail||"-"})`
            : `OFƒ∞Sƒ∞ANT (${x.createdByUid ? x.createdByUid.slice(0,6) : "-"})`;

          const det = `${x.details || "Satƒ±≈ü"} (${x.table || "-"}) | ${x.payType || "Naƒüd"} | Vuran: ${by}${itemsText}` +
                      (x.discountAmt ? ` | Endirim: ${Number(x.discountAmt).toFixed(2)}` : "") +
                      (x.serviceAmt ? ` | Servis: ${Number(x.serviceAmt).toFixed(2)}` : "");

          h.innerHTML += `
            <tr>
              <td>
                <button class="btn-action" style="width:auto; padding:8px 10px; border-radius:12px; background:rgba(255,255,255,0.10);" onclick="openSaleInfo(${x.id})">
                  <i class="fa-solid fa-circle-info"></i>
                </button>
              </td>
              <td>${x.date || ""}</td>
              <td style="color:#10b981">Satƒ±≈ü</td>
              <td>${det}</td>
              <td>${Number(x.grandTotal ?? x.revenue ?? 0).toFixed(2)}</td>
            </tr>
          `;
        } else {
          h.innerHTML += `
            <tr>
              <td></td>
              <td>${x.date || ""}</td>
              <td style="color:#ef4444">X…ôrc</td>
              <td>${x.name || ""}</td>
              <td>${(-Number(x.val||0)).toFixed(2)}</td>
            </tr>
          `;
        }
      });
    }

    function closeInfoModal(){
      const m = $("info-modal");
      const c = $("info-content");
      if(c) c.innerHTML = "";
      if(m) m.style.display = "none";
    }

    function openSaleInfo(saleId){
      if(!requireAdmin()) return;

      const sale = (sales || []).find(s => Number(s.id) === Number(saleId));
      if(!sale) return alert("√áek tapƒ±lmadƒ±!");

      const t = sale.table || "N/A";
      const filt = window.__repFilter || {};
      const from = filt.from || "";
      const to   = filt.to || "";

      const normalizeISO = (x) => x.dateISO || toISOFromLocalDateString(x.date) || "";
      const inRange = (iso) => {
        if(!iso) return true;
        if(from && iso < from) return false;
        if(to && iso > to) return false;
        return true;
      };

      const tableChecksCount = (sales || [])
        .map(s => ({...s, dateISO: normalizeISO(s)}))
        .filter(s => s.table === t && inRange(s.dateISO))
        .length;

      const items = (sale.items || []);
      const itemsHtml = items.length
        ? items.map(i => `
            <div style="display:flex; justify-content:space-between; gap:10px; padding:8px 10px; border:1px solid rgba(255,255,255,0.08); border-radius:12px; margin-bottom:8px;">
              <div style="font-weight:700;">${i.name}</div>
              <div style="opacity:.9;">x${Number(i.qty||0)}</div>
              <div style="font-weight:800; color:var(--accent);">${(Number(i.price||0)*Number(i.qty||0)).toFixed(2)} AZN</div>
            </div>
          `).join("")
        : `<div style="opacity:.8;">Sifari≈ü detali yoxdur</div>`;

      const who = sale.createdByRole === "admin"
        ? `ADMIN (${sale.createdByEmail||"-"})`
        : `OFƒ∞Sƒ∞ANT (${sale.createdByUid ? sale.createdByUid.slice(0,6) : "-"})`;

      const html = `
        <div style="display:flex; flex-wrap:wrap; gap:10px; margin-bottom:12px;">
          <div class="glass-window" style="height:auto; padding:12px; flex:1;">
            <div style="opacity:.8; font-size:12px;">Masa</div>
            <div style="font-weight:900; font-size:18px; color:var(--accent);">${t}</div>
            <div style="opacity:.85; margin-top:6px;">Bu aralƒ±qda √ßek sayƒ±: <b>${tableChecksCount}</b></div>
          </div>
          <div class="glass-window" style="height:auto; padding:12px; flex:1;">
            <div style="opacity:.8; font-size:12px;">Tarix / √ñd…ôni≈ü</div>
            <div style="font-weight:800;">${sale.date || "-"} ‚Äî ${sale.payType || "Naƒüd"}</div>
            <div style="opacity:.85; margin-top:6px;">Vuran: <b>${who}</b></div>
          </div>
          <div class="glass-window" style="height:auto; padding:12px; flex:1;">
            <div style="opacity:.8; font-size:12px;">C…ômi</div>
            <div style="font-weight:900; font-size:18px; color:var(--accent);">${Number(sale.grandTotal ?? sale.revenue ?? 0).toFixed(2)} AZN</div>
            <div style="opacity:.85; margin-top:6px;">Maya: <b>${Number(sale.cost||0).toFixed(2)}</b></div>
          </div>
        </div>

        <div style="font-weight:900; color:var(--accent); margin: 6px 0 10px;">Sifari≈ül…ôr</div>
        ${itemsHtml}
      `;

      $("info-content").innerHTML = html;
      $("info-modal").style.display = "flex";
    }

    document.addEventListener("click", (e) => {
      const m = $("info-modal");
      if(!m || m.style.display === "none") return;
      if(e.target === m) closeInfoModal();
    });

    function renderZReport(){
      if(!requireAdmin()) return;
      const iso = $("z-date").value || todayISO();

      const daySales = (sales||[]).map(s => ({...s, dateISO: s.dateISO || toISOFromLocalDateString(s.date) || ""})).filter(s => s.dateISO === iso);
      const dayExp   = (expenses||[]).map(e => ({...e, dateISO: e.dateISO || toISOFromLocalDateString(e.date) || ""})).filter(e => e.dateISO === iso);

      const byPay = {};
      let gross = 0, cost = 0, disc = 0, svc = 0;
      daySales.forEach(s => {
        const pay = s.payType || "Naƒüd";
        if(!byPay[pay]) byPay[pay] = 0;
        const g = (s.grandTotal ?? s.revenue ?? 0);
        byPay[pay] += g;
        gross += g;
        cost += (s.cost||0);
        disc += (s.discountAmt||0);
        svc += (s.serviceAmt||0);
      });

      const expSum = dayExp.reduce((a,b)=>a+(b.val||0),0);
      const profit = gross - cost - expSum;

      const payLines = Object.keys(byPay).length
        ? Object.entries(byPay).map(([k,v]) => `${k}: <b>${v.toFixed(2)}</b> AZN`).join("<br>")
        : "Satƒ±≈ü yoxdur";

      const zHtml = `
        <div><b>Tarix:</b> ${iso}</div>
        <div style="margin-top:8px;"><b>Satƒ±≈ü (√úmumi):</b> ${gross.toFixed(2)} AZN</div>
        <div><b>Endirim:</b> ${disc.toFixed(2)} AZN</div>
        <div><b>Servis:</b> ${svc.toFixed(2)} AZN</div>
        <div><b>Maya:</b> ${cost.toFixed(2)} AZN</div>
        <div style="margin-top:8px;"><b>√ñd…ôni≈ü n√∂v√ºn…ô g√∂r…ô:</b><br>${payLines}</div>
        <div style="margin-top:8px;"><b>X…ôrcl…ôr:</b> ${expSum.toFixed(2)} AZN</div>
        <div><b>Xalis m…ônf…ô…ôt:</b> ${profit.toFixed(2)} AZN</div>
        <div style="margin-top:8px; opacity:.9;"><b>√áek sayƒ±:</b> ${daySales.length}</div>
      `;

      $("z-content").innerHTML = zHtml;
      $("z-box").style.display = "block";
    }

    // ==== POS CALC + PRINT ====
    function getCurrentSubtotal(){
      if(!tables.length) return 0;
      const tName = tables[activeIdx];
      const list = tableOrders[tName] || [];
      return list.reduce((sum, i) => sum + (Number(i.price||0) * Number(i.qty||0)), 0);
    }

    function recalcTotals(){
      const sub = getCurrentSubtotal();
      const discPct = clampPct($("disc-pct")?.value ?? 0);
      const svcPct  = clampPct($("svc-pct")?.value ?? 0);

      const discAmt = sub * (discPct/100);
      const afterDisc = sub - discAmt;
      const svcAmt = afterDisc * (svcPct/100);
      const grand = afterDisc + svcAmt;

      $("sub-val").innerText  = sub.toFixed(2);
      $("disc-val").innerText = discAmt.toFixed(2);
      $("svc-val").innerText  = svcAmt.toFixed(2);
      $("total-val").innerText = grand.toFixed(2);

      return { sub, discPct, discAmt, svcPct, svcAmt, grand };
    }

    function printReceiptAction(){
      const tName = tables[activeIdx];
      const ord = tableOrders[tName] || [];
      if(!ord.length) return alert("Sifari≈ü bo≈üdur!");

      const totals = recalcTotals();
      const payType = $("pay-type")?.value || "Naƒüd";

      let html = `<div style="text-align:center"><h3>KEEPER PRO</h3><p>Masa: ${tName}</p><p>√ñd…ôni≈ü: ${payType}</p><hr style="border:1px dashed #000">`;
      ord.forEach(i => html += `<div style="display:flex; justify-content:space-between; margin:5px 0;"><span>${i.name} (x${i.qty})</span><span>${(Number(i.price||0)*Number(i.qty||0)).toFixed(2)} AZN</span></div>`);
      html += `<hr style="border:1px dashed #000">`;
      html += `<div style="display:flex; justify-content:space-between;"><span>Ara c…ômi</span><span>${totals.sub.toFixed(2)}</span></div>`;
      html += `<div style="display:flex; justify-content:space-between;"><span>Endirim (${totals.discPct}%)</span><span>${totals.discAmt.toFixed(2)}</span></div>`;
      html += `<div style="display:flex; justify-content:space-between;"><span>Servis (${totals.svcPct}%)</span><span>${totals.svcAmt.toFixed(2)}</span></div>`;
      html += `<hr style="border:1px dashed #000"><b>C∆èMƒ∞: ${totals.grand.toFixed(2)} AZN</b><br><br><p>Nu≈ü olsun!</p></div>`;

      $("print-area").innerHTML = html;
      window.print();
    }

    function printZReport(){
      if(!requireAdmin()) return;
      const iso = $("z-date").value || todayISO();
      renderZReport();
      const content = $("z-content").innerHTML;

      const html = `
        <div style="text-align:center">
          <h3>KEEPER PRO</h3>
          <p>Z-REPORT</p>
          <p>${iso}</p>
        </div>
        <hr style="border:1px dashed #000">
        <div style="font-size:12px; line-height:1.6;">
          ${content}
        </div>
        <hr style="border:1px dashed #000">
        <div style="text-align:center; margin-top:10px;">Baƒülanƒ±≈ü tamamlandƒ±</div>
      `;
      $("print-area").innerHTML = html;
      window.print();
    }

    // ==== ACTIONS ====
    async function selectTable(i){
      activeIdx = i;
      renderTables();
      renderOrderList();
      recalcTotals();
    }

    async function addTablePrompt(){
      if(!requireAdmin()) return;
      let n = prompt("Masa:");
      if(!n) return;
      n = n.trim();
      if(!n) return;
      if(tables.includes(n)) return alert("Bu masa artƒ±q var!");
      tables.push(n);
      tableOrders[n] = [];
      await writeTablesState();
    }

    async function addItemToOrder(encodedName){
      const n = decName(encodedName);

      if(!tables.length) return alert("Masa yoxdur. Admin masalarƒ± …ôlav…ô etm…ôlidir.");
      if(activeIdx < 0 || activeIdx >= tables.length) activeIdx = 0;

      if(!inventory[n] || Number(inventory[n].qty||0) <= 0) return alert("M…ôhsul bitib!");

      const tName = tables[activeIdx];
      const order = tableOrders[tName] || (tableOrders[tName] = []);

      const existing = order.find(i => i.name === n);
      if(existing){
        if(existing.qty + 1 > Number(inventory[n].qty||0)) return alert("Stok √ßatƒ±≈ümƒ±r!");
        existing.qty += 1;
      } else {
        order.push({ name: n, qty: 1, price: Number(inventory[n].sell||0), cost: Number(inventory[n].cost||0) });
      }

      await writeTablesState();
    }

    async function updateOrderQty(encodedName, delta){
      const n = decName(encodedName);
      if(!tables.length) return;

      const tName = tables[activeIdx];
      const list = tableOrders[tName] || (tableOrders[tName] = []);
      const item = list.find(i => i.name === n);
      if(!item) return;

      if(delta > 0){
        if(item.qty + 1 > Number(inventory[n]?.qty ?? 0)) return alert("Stok yoxdur!");
      }

      item.qty += Number(delta||0);
      if(item.qty <= 0){
        tableOrders[tName] = list.filter(i => i.name !== n);
      }

      await writeTablesState();
    }

    async function removeOrderItem(encodedName){
      const n = decName(encodedName);
      if(!tables.length) return;
      const tName = tables[activeIdx];
      tableOrders[tName] = (tableOrders[tName] || []).filter(i => i.name !== n);
      await writeTablesState();
    }

    async function savePurchaseAction(){
      if(!requireAdmin()) return;

      const n = $("p-name").value.trim();
      const q = parseFloat($("p-qty").value);
      const c = parseFloat($("p-cost").value);
      const s = parseFloat($("p-sell").value);
      const m = parseFloat($("p-min").value);

      if(!n || isNaN(q) || q<=0) return alert("M…ôhsul adƒ± v…ô miqdar d√ºzg√ºn yazƒ±lmalƒ±dƒ±r.");
      if(isNaN(c) || c<0) return alert("Alƒ±≈ü qiym…ôti d√ºzg√ºn yazƒ±lmalƒ±dƒ±r.");
      if(isNaN(s) || s<0) return alert("Satƒ±≈ü qiym…ôti d√ºzg√ºn yazƒ±lmalƒ±dƒ±r.");

      const inv = inventory[n] || { name: n, qty: 0, sell: s, cost: c, minQty: 5 };
      inv.qty = Number(inv.qty||0) + q;
      inv.sell = s;
      inv.cost = c;
      inv.minQty = isNaN(m) ? (inv.minQty ?? 5) : m;

      await upsertInventoryItem(n, inv);

      const id = Date.now();
      const purObj = { id, date: new Date().toLocaleDateString(), dateISO: todayISO(), name: n, qty: q, cost: c };
      await setDoc(refBranch("purchases", String(id)), purObj, { merge: true });

      $("p-name").value="";
      $("p-qty").value="";
      $("p-cost").value="";
      $("p-sell").value="";
      $("p-min").value="";

      alert("Mal anbara vuruldu!");
      notifyLowStock();
    }

    async function delPur(id){
      if(!requireAdmin()) return;

      const pRef = refBranch("purchases", String(id));

      try{
        await runTransaction(db, async (tx) => {
          const pSnap = await tx.get(pRef);
          if(!pSnap.exists()) throw new Error("Alƒ±≈ü tapƒ±lmadƒ±!");
          const p = pSnap.data();

          const invName = p.name;
          const invRef = refBranch("inventory", safeId(invName));
          const invSnap = await tx.get(invRef);
          if(!invSnap.exists()) throw new Error("Stok tapƒ±lmadƒ±!");

          const inv = invSnap.data();
          const newQty = Number(inv.qty||0) - Number(p.qty||0);
          if(newQty < 0) throw new Error("Silinmir: stok m…ônfiy…ô d√º≈ü√ºr (artƒ±q satƒ±≈ü ola bil…ôr).");

          tx.update(invRef, { qty: newQty });
          tx.delete(pRef);
        });
      } catch(err){
        alert(err?.message || "X…ôta ba≈ü verdi!");
      }
    }

    // ‚úÖ COMPLETE ORDER: h…ôm admin, h…ôm staff i≈ül…ôsin + kim vurdu yazƒ±lsƒ±n
    async function completeOrderAction(){
      const tName = tables[activeIdx];
      const order = tableOrders[tName] || [];
      if(!order.length) return alert("Sifari≈ü bo≈üdur!");

      const totals = recalcTotals();
      const payType = $("pay-type")?.value || "Naƒüd";

      const saleId = Date.now();
      const saleRef = refBranch("sales", String(saleId));

      try{
        await runTransaction(db, async (tx) => {

          // 1) READ-L∆èR
          const tablesSnap = await tx.get(refTables);
          if(!tablesSnap.exists()) throw new Error("Tables state tapƒ±lmadƒ±!");

          const invSnaps = [];
          for(const it of order){
            const invRef = refBranch("inventory", safeId(it.name));
            const invSnap = await tx.get(invRef);
            if(!invSnap.exists()) throw new Error("Stok tapƒ±lmadƒ±: " + it.name);
            invSnaps.push({ it, invRef, inv: invSnap.data() });
          }

          // 2) HESAB
          let cst = 0;
          for(const x of invSnaps){
            const have = Number(x.inv.qty || 0);
            const need = Number(x.it.qty || 0);
            if(have < need) throw new Error("Stok √ßatmƒ±r: " + x.it.name);
            cst += Number(x.inv.cost || 0) * need;
          }

          // 3) WRITE-L∆èR
          for(const x of invSnaps){
            const have = Number(x.inv.qty || 0);
            const need = Number(x.it.qty || 0);
            tx.update(x.invRef, { qty: have - need });
          }

          const whoRole = isAdmin() ? "admin" : "staff";
          const whoUid = currentUser?.uid || null;
          const whoEmail = currentUser?.email || null;

          const saleObj = {
            id: saleId,
            date: new Date().toLocaleDateString(),
            dateISO: todayISO(),
            revenue: totals.sub,
            cost: cst,
            details: tName + " Satƒ±≈üƒ±",
            table: tName,
            payType,
            discountPct: totals.discPct,
            discountAmt: totals.discAmt,
            servicePct: totals.svcPct,
            serviceAmt: totals.svcAmt,
            grandTotal: totals.grand,
            items: order.map(x => ({ name: x.name, qty: x.qty, price: x.price })),
            createdByRole: whoRole,
            createdByUid: whoUid,
            createdByEmail: whoEmail
          };
          tx.set(saleRef, saleObj, { merge: true });

          const d = tablesSnap.data() || {};
          const tbl = Array.isArray(d.tables) && d.tables.length ? d.tables : tables;
          const ords = d.tableOrders || {};
          tbl.forEach(t => { if(!Array.isArray(ords[t])) ords[t] = []; });
          ords[tName] = [];
          tx.set(refTables, { tables: tbl, tableOrders: ords }, { merge: true });
        });

        $("disc-pct").value = "";
        $("svc-pct").value = "";
        $("pay-type").value = "Naƒüd";

        alert("Sifari≈ü tamamlandƒ±!");
        notifyLowStock();

      } catch(err){
        alert(err?.message || "X…ôta ba≈ü verdi!");
      }
    }

    async function saveExpenseAction(){
      if(!requireAdmin()) return;

      const n = $("ex-n").value.trim();
      const v = parseFloat($("ex-v").value);
      const cash = getCashNow();

      if(!n || isNaN(v) || v<=0) return alert("M…ôlumatlarƒ± d√ºzg√ºn daxil et!");
      if(v > cash) return alert("Kassada yet…ôrli m…ôbl…ôƒü yoxdur!");

      const id = Date.now();
      const obj = { id, date: new Date().toLocaleDateString(), dateISO: todayISO(), name: n, val: v };
      await setDoc(refBranch("expenses", String(id)), obj, { merge: true });

      $("ex-n").value = "";
      $("ex-v").value = "";
    }

    async function deleteExpense(id){
      if(!requireAdmin()) return;
      await deleteDoc(refBranch("expenses", String(id)));
    }

    async function setResetCodePrompt(){
      if(!requireAdmin()) return;

      const curr = await getResetCode();
      const entered = prompt("Hazƒ±rkƒ± reset kodunu yaz:");
      if(entered === null) return;
      if(String(entered) !== String(curr)) return alert("Kod s…ôhvdir!");

      const n1 = prompt("Yeni reset kodu t…ôyin et (m…ôs: 7788):");
      if(n1 === null) return;
      if(!String(n1).trim()) return alert("Kod bo≈ü ola bilm…ôz!");
      const n2 = prompt("Yeni reset kodunu t…ôkrar yaz:");
      if(n2 === null) return;
      if(String(n1) !== String(n2)) return alert("Kodlar uyƒüun deyil!");

      await setResetCode(n1);
      alert("Reset kodu yenil…ôndi!");
    }

    async function resetDataPrompt(){
      if(!requireAdmin()) return;

      const code = prompt("B√úT√úN DATANI SIFIRLAMAQ √ú√á√úN RESET KODUNU YAZ:");
      if(code === null) return;
      const real = await getResetCode();
      if(String(code) !== String(real)) return alert("Kod s…ôhvdir!");

      const confirmText = prompt("T…ôsdiq √º√ß√ºn 'SIFIRLA' yaz:");
      if(confirmText === null) return;
      if(String(confirmText).trim().toUpperCase() !== "SIFIRLA") return alert("T…ôsdiq l…ôƒüv edildi.");

      try{
        const batch = writeBatch(db);

        const cols = ["inventory","purchases","sales","expenses"];
        for(const c of cols){
          const snap = await getDocs(colBranch(c));
          snap.forEach(d => batch.delete(d.ref));
        }

        const newTables = ["Masa 1","Masa 2","Masa 3"];
        const newOrders = {};
        newTables.forEach(t => newOrders[t] = []);
        batch.set(refTables, { tables: newTables, tableOrders: newOrders }, { merge: false });

        await batch.commit();

        tables = newTables;
        tableOrders = newOrders;
        activeIdx = 0;

        alert("B√ºt√ºn data sƒ±fƒ±rlandƒ±!");
      } catch(err){
        alert(err?.message || "Sƒ±fƒ±rlama zamanƒ± x…ôta!");
      }
    }

    // ==== LOGIN / NAV ====
    function promptAdmin(){
      $("role-btns").style.display="none";
      $("admin-pass-container").style.display="block";
      $("admin-email").value = ADMIN_EMAIL_DEFAULT;
      $("admin-password").value = "";
    }
    function cancelAdmin(){
      $("admin-pass-container").style.display="none";
      $("role-btns").style.display="block";
      $("admin-password").value = "";
    }

    async function tryAdminLogin(){
      const email = $("admin-email").value.trim();
      const pass = $("admin-password").value;

      if(!email || !pass) return alert("Email v…ô parol yaz!");
      try{
        const cred = await signInWithEmailAndPassword(auth, email, pass);
        currentUser = cred.user;
        currentRole = "admin";
        await loginUser("admin");
      }catch(e){
        alert("Parol s…ôhvdir / giri≈ü alƒ±nmadƒ±!");
      }
    }

    async function loginUser(role){
      if(role === "staff"){
        try{
          const cred = await signInAnonymously(auth);
          currentUser = cred.user;
        }catch(e){
          currentUser = auth.currentUser;
        }
        currentRole = "staff";
      }

      $("login-overlay").style.display="none";

      document.querySelectorAll(".admin-only").forEach(el => {
        el.style.display = (currentRole === "admin" ? "flex" : "none");
      });

      const firstNav = document.querySelector(".nav-item");
      if(firstNav) switchTab("pos", firstNav);

      await initSystem();
    }

    async function logoutAction(){
      stopRealtime();
      if(clockTimer) { clearInterval(clockTimer); clockTimer = null; }

      try{ await signOut(auth); }catch(e){}

      $("login-overlay").style.display="flex";
      cancelAdmin();

      $("admin-email").value = "";
      $("admin-password").value = "";

      currentRole = "staff";
      currentUser = null;

      document.querySelectorAll(".admin-only").forEach(el => el.style.display = "none");

      const firstNav = document.querySelector(".nav-item");
      if(firstNav) switchTab("pos", firstNav);
    }

    async function initSystem(){
      await ensureInitDocs();
      startRealtime();

      const iso = todayISO();
      const repFrom = $("rep-from");
      const repTo = $("rep-to");
      const zDate = $("z-date");
      if(repFrom && !repFrom.value) repFrom.value = iso;
      if(repTo && !repTo.value) repTo.value = iso;
      if(zDate && !zDate.value) zDate.value = iso;

      if(clockTimer) clearInterval(clockTimer);
      clockTimer = setInterval(() => {
        $("clock").innerText = new Date().toLocaleTimeString("az-AZ");
      }, 1000);

      renderTables();
      renderMenu();
      renderOrderList();
      recalcTotals();

      if(isAdmin()){
        renderPurchases();
        renderExpenses();
        fillReportTablesDropdown();
      }
    }

    function switchTab(v, el){
      const adminViews = ["purchase","stock","expense","report"];
      if(adminViews.includes(v) && !isAdmin()){
        alert("Bu b√∂lm…ô yalnƒ±z ADMIN √º√ß√ºnd√ºr!");
        return;
      }

      document.querySelectorAll(".view").forEach(x => x.classList.remove("active"));
      document.querySelectorAll(".nav-item").forEach(n => n.classList.remove("active"));

      document.getElementById("view-" + v).classList.add("active");
      el.classList.add("active");

      if(v==="stock") renderStock();
      if(v==="report") renderReport();
      if(v==="expense") renderExpenses();
      if(v==="purchase") renderPurchases();
      if(v==="pos") { renderMenu(); renderOrderList(); recalcTotals(); }

      const titles = { pos: "Satƒ±≈ü Terminalƒ±", purchase:"Alƒ±≈ü (ƒ∞dxal)", stock:"Stok (Anbar)", expense:"X…ôrcl…ôr", report:"Hesabatlar" };
      $("page-title").innerText = titles[v] || "Keeper Pro";
    }

    // AUTH STATE
    onAuthStateChanged(auth, (u) => {
      currentUser = u || null;
    });

    // ==== EXPORTS FOR onclick ====
    window.promptAdmin = promptAdmin;
    window.cancelAdmin = cancelAdmin;
    window.tryAdminLogin = tryAdminLogin;
    window.loginUser = loginUser;
    window.logoutAction = logoutAction;

    window.switchTab = switchTab;

    window.selectTable = selectTable;
    window.addTablePrompt = addTablePrompt;

    window.addItemToOrder = addItemToOrder;
    window.updateOrderQty = updateOrderQty;
    window.removeOrderItem = removeOrderItem;

    window.recalcTotals = recalcTotals;
    window.printReceiptAction = printReceiptAction;
    window.completeOrderAction = completeOrderAction;

    window.savePurchaseAction = savePurchaseAction;
    window.delPur = delPur;

    window.saveExpenseAction = saveExpenseAction;
    window.deleteExpense = deleteExpense;

    window.renderReport = renderReport;
    window.renderZReport = renderZReport;
    window.printZReport = printZReport;

    window.resetDataPrompt = resetDataPrompt;
    window.setResetCodePrompt = setResetCodePrompt;

    window.openSaleInfo = openSaleInfo;
    window.closeInfoModal = closeInfoModal;
  </script>
</body>
</html>